<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Neon Tree Exploration ‚Äì SpinnerRealYT</title>
<link rel="icon" href="../Logo.png">

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style>
/* --- CSS: STYLIZACJA --- */
:root { 
    --bg: #020617; 
    --card: #0f172a; 
    --accent: #38bdf8; 
    --text: #e5e7eb; 
    --gold: #facc15; 
    --path: #1e293b; 
    --danger: #f87171; 
    --void-color: #6d28d9; 
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { 
    margin: 0; 
    font-family: 'Inter', sans-serif; 
    background: #000; 
    color: var(--text); 
    overflow: hidden; 
    touch-action: none; 
}

/* STREFA 1: VOID (Upgrade 1-40) */
body.zone-void #world-map { 
    background-color: #050510;
    background-image: 
        linear-gradient(rgba(109, 40, 217, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(109, 40, 217, 0.05) 1px, transparent 1px);
    background-size: 60px 60px;
}

#game-viewport { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
#world-map { position: absolute; width: 5000px; height: 5000px; transition: 0.3s; }

#player {
    position: absolute; width: 32px; height: 32px; background: var(--accent);
    box-shadow: 0 0 25px var(--accent); border-radius: 10px; z-index: 100;
    transition: transform 0.1s;
}

.node {
    position: absolute; width: 160px; height: 160px; background: var(--card);
    border: 4px solid var(--path); border-radius: 24px; display: none;
    flex-direction: column; align-items: center; justify-content: center;
    text-align: center; padding: 15px; z-index: 50; transition: 0.3s;
}
.node.visible { display: flex; animation: fadeIn 0.5s ease-out forwards; }
.node .up-number { font-size: 10px; color: var(--gold); font-weight: 900; margin-bottom: 5px; }
.node b { font-size: 13px; color: var(--accent); text-transform: uppercase; }
.node .cost-txt { font-weight: 800; font-size: 14px; margin-top: auto; padding: 5px 10px; border-radius: 8px; }

/* UI */
#ui { position: fixed; top: 25px; width: 100%; text-align: center; z-index: 200; pointer-events: none; }
.currency { font-size: 42px; font-weight: 900; color: var(--accent); text-shadow: 0 0 20px rgba(56, 189, 248, 0.4); }

/* PANEL PROFILU (MODAL) */
#account-info {
    position: fixed; top: 20px; left: 20px; background: rgba(15, 23, 42, 0.85);
    padding: 12px 18px; border-radius: 15px; border-left: 4px solid var(--accent);
    font-size: 14px; z-index: 400; backdrop-filter: blur(8px); cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}
#account-info:hover { background: var(--card); border-left-color: var(--gold); }

#profile-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); display: none; justify-content: center;
    align-items: center; z-index: 1000; backdrop-filter: blur(10px);
}
#profile-card {
    background: var(--card); border: 2px solid var(--path); width: 320px;
    padding: 30px; border-radius: 28px; text-align: center; box-shadow: 0 0 40px rgba(0,0,0,1);
}
.profile-stat { margin: 15px 0; font-size: 15px; display: flex; justify-content: space-between; }
#reset-btn {
    background: var(--danger); color: white; border: none; padding: 14px;
    border-radius: 12px; font-weight: 800; cursor: pointer; width: 100%;
    margin-top: 20px; transition: 0.2s;
}
#reset-btn:hover { transform: scale(1.02); filter: brightness(1.1); }

/* ≈öCIE≈ªKI */
#path-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
line { stroke: var(--path); stroke-width: 8; stroke-linecap: round; transition: 0.5s; }
line.active { stroke: var(--accent); stroke-dasharray: 15; animation: dash 1.5s linear infinite; }

@keyframes dash { from { stroke-dashoffset: 30; } to { stroke-dashoffset: 0; } }
@keyframes fadeIn { from { opacity: 0; transform: translateY(20px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
</style>
</head>
<body class="zone-void">

<div id="account-info" onclick="openProfile()">
    üë§ <b id="user-display">≈Åadowanie...</b>
    <span id="sync-status" style="display:block; font-size:10px; opacity:0.6; margin-top:3px;">Synchronizacja...</span>
</div>

<div id="profile-overlay" onclick="if(event.target===this) closeProfile()">
    <div id="profile-card">
        <h2 style="margin:0; color:var(--accent);">Profil Eksploratora</h2>
        <p id="prof-user" style="opacity:0.6; margin: 5px 0 20px 0;"></p>
        <div class="profile-stat"><span>Postƒôp:</span> <b id="prof-nodes">0/40</b></div>
        <div class="profile-stat"><span>Szybko≈õƒá:</span> <b id="prof-speed">0</b></div>
        <div class="profile-stat"><span>Punkty:</span> <b id="prof-pts">0</b></div>
        <button id="reset-btn" onclick="resetData()">RESETUJ POSTƒòP I WYLOGUJ</button>
        <button onclick="closeProfile()" style="margin-top:15px; background:none; border:none; color:var(--text); opacity:0.5; cursor:pointer;">Zamknij</button>
    </div>
</div>

<div id="ui">
    <div class="currency"><span id="points">0</span> Œî</div>
    <div style="font-weight:bold; opacity: 0.8; font-size:14px;">ZYSK: +<span id="pps">0</span>/s</div>
</div>

<div id="game-viewport">
    <div id="world-map">
        <svg id="path-layer"></svg>
        <div id="player"></div>
    </div>
</div>

<script>
/* --- JS: LOGIKA --- */
const firebaseConfig = { databaseURL: "https://spinnerrealyt-games-default-rtdb.europe-west1.firebasedatabase.app/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const currentUser = localStorage.getItem("sp_logged") || "Go≈õƒá";

let state = {
    points: 0, pps: 0, pX: 2500, pY: 2500, speed: 6,
    unlockedNodes: ["up1"], purchasedLevels: { "up1": 0 }, lockedOut: [],
    teleports: []
};

// Przyk≈Çadowe ulepszenia (ZalƒÖ≈ºek strefy 1-40)
const nodes = {
    "up1": { num: 1, x: 2500, y: 2500, name: "Rdze≈Ñ Voidu", desc: "Start", cost: 0, max: 1, pps: 1, next: ["up2"] },
    "up2": { num: 2, x: 2500, y: 2200, name: "Szybki Impuls", desc: "Zysk", cost: 25, max: 10, pps: 2, next: ["up3"] },
    "up3": { num: 3, x: 2200, y: 2200, name: "Zwinno≈õƒá", desc: "Prƒôdko≈õƒá", cost: 150, max: 5, speed: 1.5, next: ["up4"] },
    "up4": { num: 4, x: 1900, y: 2200, name: "Ciemna Materia", desc: "Masa", cost: 500, max: 10, pps: 12, next: [] } 
    // Dodaj tutaj kolejne ulepszenia a≈º do num: 40
};

const keys = {};
window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => keys[e.key.toLowerCase()] = false;

// PROFIL
function openProfile() {
    document.getElementById('profile-overlay').style.display = 'flex';
    document.getElementById('prof-user').innerText = currentUser;
    document.getElementById('prof-nodes').innerText = `${state.unlockedNodes.length}/40`;
    document.getElementById('prof-speed').innerText = state.speed;
    document.getElementById('prof-pts').innerText = Math.floor(state.points);
}
function closeProfile() { document.getElementById('profile-overlay').style.display = 'none'; }

// FIREBASE
async function saveToCloud() {
    if(currentUser === "Go≈õƒá") return;
    try {
        await db.ref('users/' + currentUser + '/stats/neon_tree').set(state);
        document.getElementById('sync-status').innerText = "Zsynchronizowano ‚úÖ";
    } catch(e) { document.getElementById('sync-status').innerText = "B≈ÇƒÖd zapisu ‚ùå"; }
}

async function loadFromCloud() {
    if(currentUser === "Go≈õƒá") {
        document.getElementById('user-display').innerText = "GO≈öƒÜ (Brak zapisu)";
        return;
    }
    document.getElementById('user-display').innerText = currentUser.toUpperCase();
    try {
        const snap = await db.ref('users/' + currentUser + '/stats/neon_tree').once('value');
        if(snap.exists()) {
            state = Object.assign({}, state, snap.val());
            document.getElementById('sync-status').innerText = "Dane wczytane ‚òÅÔ∏è";
        }
    } catch(e) { document.getElementById('sync-status').innerText = "B≈ÇƒÖd po≈ÇƒÖczenia"; }
}

function resetData() {
    if(confirm("UWAGA: Wszystkie dane zostanƒÖ usuniƒôte z chmury, a Ty zostaniesz wylogowany. Kontynuowaƒá?")) {
        db.ref('users/' + currentUser + '/stats/neon_tree').remove().then(() => {
            localStorage.clear();
            location.href = "../index.html"; 
        });
    }
}

// SILNIK GRY
function init() {
    const map = document.getElementById('world-map');
    const svg = document.getElementById('path-layer');
    
    for (let id in nodes) {
        const n = nodes[id];
        const div = document.createElement('div');
        div.className = 'node';
        div.id = `node-${id}`;
        div.style.left = (n.x - 80) + 'px'; div.style.top = (n.y - 80) + 'px';
        map.appendChild(div);
        
        if (n.next) {
            n.next.forEach(nxt => {
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", n.x); line.setAttribute("y1", n.y);
                line.setAttribute("x2", nodes[nxt].x); line.setAttribute("y2", nodes[nxt].y);
                line.id = `path-${id}-${nxt}`;
                svg.appendChild(line);
            });
        }
    }
    requestAnimationFrame(gameLoop);
}

function gameLoop() {
    let mx = 0, my = 0;
    if (keys['w'] || keys['arrowup']) my -= state.speed;
    if (keys['s'] || keys['arrowdown']) my += state.speed;
    if (keys['a'] || keys['arrowleft']) mx -= state.speed;
    if (keys['d'] || keys['arrowright']) mx += state.speed;
    
    state.pX += mx; state.pY += my;
    
    // Kamera i gracz
    document.getElementById('world-map').style.left = (window.innerWidth/2 - state.pX) + 'px';
    document.getElementById('world-map').style.top = (window.innerHeight/2 - state.pY) + 'px';
    const p = document.getElementById('player');
    p.style.left = (state.pX - 16) + 'px';
    p.style.top = (state.pY - 16) + 'px';

    // Zakupy przez dotyk (kolizja)
    for (let id in nodes) {
        if (!state.unlockedNodes.includes(id) || state.lockedOut.includes(id)) continue;
        const n = nodes[id];
        if (Math.hypot(state.pX - n.x, state.pY - n.y) < 70) {
            if (state.points >= n.cost && (state.purchasedLevels[id]||0) < n.max) {
                buyNode(id);
            }
        }
    }

    state.points += state.pps / 60;
    updateUI();
    requestAnimationFrame(gameLoop);
}

function buyNode(id) {
    const n = nodes[id];
    state.points -= n.cost;
    state.purchasedLevels[id] = (state.purchasedLevels[id] || 0) + 1;
    if (n.pps) state.pps += n.pps;
    if (n.speed) state.speed += n.speed;
    
    // Odblokowanie kolejnych
    if (state.purchasedLevels[id] === 1 && n.next) {
        n.next.forEach(nxt => { if(!state.unlockedNodes.includes(nxt)) state.unlockedNodes.push(nxt); });
    }
    saveToCloud();
}

function updateUI() {
    document.getElementById('points').innerText = Math.floor(state.points).toLocaleString();
    document.getElementById('pps').innerText = state.pps.toFixed(1);
    
    for (let id in nodes) {
        const el = document.getElementById(`node-${id}`);
        if (state.unlockedNodes.includes(id)) {
            el.classList.add('visible');
            const n = nodes[id];
            const lvls = state.purchasedLevels[id] || 0;
            const canAfford = state.points >= n.cost;
            
            el.innerHTML = `
                <div class="up-number">#${n.num}</div>
                <b>${n.name}</b>
                <div class="cost-txt" style="color:${lvls >= n.max ? 'var(--gold)' : (canAfford ? '#4ade80' : '#f87171')}">
                    ${lvls >= n.max ? 'AKTYWNE' : n.cost + ' Œî'}
                </div>
            `;
            
            if (lvls > 0 && n.next) {
                n.next.forEach(nxt => {
                    const l = document.getElementById(`path-${id}-${nxt}`);
                    if(l) l.classList.add('active');
                });
            }
        }
    }
}

// Start
window.onload = async () => {
    await loadFromCloud();
    init();
    setInterval(saveToCloud, 10000);
};
</script>
</body>
</html>
