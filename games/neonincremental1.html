<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Neon Tree Exploration – SpinnerRealYT</title>
<link rel="icon" href="../Logo.png">

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style>
:root{ --bg:#020617; --card:#0f172a; --accent:#38bdf8; --text:#e5e7eb; --gold:#facc15; --path:#1e293b; --danger:#f87171;}
*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
body{ margin:0; font-family:Inter,system-ui,sans-serif; background:var(--bg); color:var(--text); overflow:hidden; touch-action:none; }

#game-viewport { position: relative; width: 100vw; height: 100vh; overflow: hidden; background: #000; }
#world-map { position: absolute; width: 5000px; height: 5000px; background-image: radial-gradient(circle, #1e293b 1px, transparent 1px); background-size: 60px 60px; }

#player {
    position: absolute; width: 30px; height: 30px; background: var(--accent);
    box-shadow: 0 0 20px var(--accent); border-radius: 8px; z-index: 100;
}

.node {
    position: absolute; width: 160px; height: 160px; background: var(--card);
    border: 4px solid var(--path); border-radius: 24px; display: none;
    flex-direction: column; align-items: center; justify-content: center;
    text-align: center; padding: 15px; z-index: 50; transition: 0.2s;
}
.node.visible { display: flex; animation: fadeIn 0.4s forwards; }
.node .up-number { font-size: 10px; color: var(--gold); font-weight: 900; margin-bottom: 2px; }
.node b { font-size: 13px; color: var(--accent); text-transform: uppercase; margin-bottom: 4px; }
.node .type-tag { font-size: 9px; background: rgba(56,189,248,0.15); padding: 2px 6px; border-radius: 10px; margin-bottom: 5px; color: #fff; }
.node i { font-size: 11px; opacity: 0.7; font-style: normal; margin-bottom: 5px; line-height: 1.1; min-height: 24px; }
.node small { font-size: 11px; font-weight: bold; margin-bottom: 5px; color: var(--text); }
.node .cost-txt { font-weight: 800; font-size: 14px; margin-top: auto; }

.node.can-afford { border-color: #4ade80; box-shadow: 0 0 20px rgba(74, 222, 128, 0.2); }
.node.maxed { border-color: var(--gold); }
.node.teleport-node { border-style: dashed; border-color: var(--gold); }

#path-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
line { stroke: var(--path); stroke-width: 8; stroke-linecap: round; }
line.active { stroke: var(--accent); stroke-dasharray: 15; animation: dash 1.5s linear infinite; }
line.hidden { display: none; }

@keyframes dash { from { stroke-dashoffset: 30; } to { stroke-dashoffset: 0; } }
@keyframes fadeIn { from { opacity: 0; transform: scale(0.6); } to { opacity: 1; transform: scale(1); } }

#ui { position: fixed; top: 25px; width: 100%; text-align: center; z-index: 200; pointer-events: none; }
.currency { font-size: 38px; font-weight: 900; color: var(--accent); text-shadow: 0 0 15px rgba(56, 189, 248, 0.5); }

#account-info {
    position: fixed; top: 20px; left: 20px; background: rgba(15,23,42,0.8);
    padding: 10px 15px; border-radius: 12px; border-left: 4px solid var(--accent);
    font-size: 13px; z-index: 400; backdrop-filter: blur(5px);
}

#sync-status { font-size: 10px; opacity: 0.6; display: block; margin-top: 2px; }

#sync-bar {
    position: fixed; top: 20px; right: 20px; z-index: 400; display: flex; gap: 5px;
}
.sync-btn {
    background: var(--card); border: 1px solid var(--accent); color: var(--accent);
    padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 11px;
}

#tp-menu { position: fixed; bottom: 120px; right: 20px; display: none; flex-direction: column; gap: 10px; z-index: 500; }
.tp-btn { background: var(--card); border: 2px solid var(--gold); color: white; padding: 12px; border-radius: 12px; cursor: pointer; font-size: 12px; }
#tp-toggle {
    position: fixed; bottom: 30px; right: 30px; width: 70px; height: 70px;
    background: var(--gold); color: #000; border-radius: 50%; border: none;
    font-weight: 900; font-size: 24px; cursor: pointer; display: none; z-index: 501;
}

#mobile-controls { position: fixed; bottom: 30px; left: 20px; display: none; grid-template-areas: ". up ." "left down right"; gap: 12px; z-index: 300; }
.joy-btn { width: 60px; height: 60px; background: rgba(15, 23, 42, 0.85); border: 2px solid var(--accent); border-radius: 15px; color: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 24px; }
#reset-btn { background: var(--danger); color: white; border: none; padding: 10px 15px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 12px;}
</style>
</head>
<body>

<div id="account-info">
    Zalogowano: <b id="user-display">Gość</b>
    <span id="sync-status">Lokalny zapis</span>
</div>

<div id="sync-bar">
    <button class="sync-btn" onclick="location.href='../index.html'">MENU</button>
    <button id="reset-btn" onclick="resetData()">RESET</button>
</div>

<div id="ui">
    <div class="currency"><span id="points">0</span> Δ</div>
    <div style="font-weight:bold; opacity: 0.8;">+<span id="pps">0</span>/s</div>
</div>

<div id="game-viewport">
    <div id="world-map">
        <svg id="path-layer"></svg>
        <div id="player"></div>
    </div>
</div>

<button id="tp-toggle" onclick="toggleTP()">1</button>
<div id="tp-menu"></div>

<div id="mobile-controls">
    <div class="joy-btn" style="grid-area: up" id="btn-up">▲</div>
    <div class="joy-btn" style="grid-area: left" id="btn-left">◀</div>
    <div class="joy-btn" style="grid-area: down" id="btn-down">▼</div>
    <div class="joy-btn" style="grid-area: right" id="btn-right">▶</div>
</div>

<script>
// --- KONFIGURACJA FIREBASE ---
const firebaseConfig = { databaseURL: "https://spinnerrealyt-games-default-rtdb.europe-west1.firebasedatabase.app/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const currentUser = localStorage.getItem("sp_logged") || null;
const currentPass = localStorage.getItem("sp_pass") || null;

// --- STAN GRY ---
let state = {
    points: 0, pps: 0, pX: 2500, pY: 2500, speed: 6,
    unlockedNodes: ["up1"], purchasedLevels: { "up1": 0 }, lockedOut: [],
    teleports: []
};

const nodes = {
    "up1": { num: 1, x: 2500, y: 2500, name: "Rdzeń Startowy", type: "Generacja", desc: "Twoje pierwsze źródło Δ", cost: 0, max: 1, pps: 1, next: ["up2"] },
    "up2": { num: 2, x: 2500, y: 2200, name: "Szybki Przesył", type: "Generacja", desc: "Zwiększa wydajność", cost: 20, max: 10, pps: 3, next: ["up3"] },
    "up3": { num: 3, x: 2200, y: 2200, name: "Lekkie Buty", type: "Prędkość", desc: "Poruszaj się szybciej", cost: 100, max: 5, speed: 2, next: ["up4", "up5"] },
    "up4": { num: 4, x: 1900, y: 2200, name: "Kolektor Many", type: "Generacja", desc: "Zbiera energię z otoczenia", cost: 400, max: 10, pps: 15, next: ["up6"] },
    "up5": { num: 5, x: 2200, y: 1900, name: "Stabilizator", type: "Wzmocnienie", desc: "Wzmacnia bazowy zysk", cost: 500, max: 5, pps: 25, next: ["up6"] },
    "up6": { num: 6, x: 1900, y: 1900, name: "Ciężki Reaktor", type: "Generacja", desc: "Masywna produkcja Δ", cost: 1500, max: 20, pps: 100, next: ["up7"] },
    "up7": { num: 7, x: 2200, y: 1600, name: "Węzeł Decyzyjny", type: "Wybór", desc: "Odblokowuje rozwidlenie", cost: 2500, max: 1, next: ["up8", "up9"] },
    "up8": { num: 8, x: 1900, y: 1300, name: "Niestabilna Moc", type: "Generacja", desc: "Ryzykowny zysk", cost: 5000, max: 1, pps: 1000, next: ["up10"], partOfChoice: ["up9"] },
    "up9": { num: 9, x: 2500, y: 1300, name: "Stały Przepływ", type: "Generacja", desc: "Pewny i solidny zysk", cost: 5000, max: 10, pps: 300, next: ["up10"], partOfChoice: ["up8"] },
    "up10": { num: 10, x: 2200, y: 1000, name: "Teleport Alpha", type: "Teleportacja", desc: "Odblokuj skok tutaj", cost: 10000, max: 1, next: ["end"] },
    "end": { num: 11, x: 2200, y: 700, name: "Wrota Wymiaru", type: "Finał", desc: "Koniec?", cost: 500000, max: 1, pps: 10000, next: [] }
};

const keys = {};
window.onkeydown = e => {
    keys[e.key.toLowerCase()] = true;
    if(e.key === "1" && state.teleports.length > 0) toggleTP();
};
window.onkeyup = e => keys[e.key.toLowerCase()] = false;

// --- FUNKCJE SYNCHRONIZACJI ---
async function saveToCloud() {
    if(!currentUser || !currentPass) return;
    try {
        await db.ref('users/' + currentUser).update({
            p: currentPass,
            "stats/neon_tree": state
        });
        document.getElementById('sync-status').innerText = "Zsynchronizowano ✅";
    } catch(e) {
        document.getElementById('sync-status').innerText = "Błąd zapisu ❌";
    }
}

async function loadFromCloud() {
    if(!currentUser) return;
    document.getElementById('user-display').innerText = currentUser.toUpperCase();
    document.getElementById('sync-status').innerText = "Wczytywanie...";
    
    try {
        const snap = await db.ref('users/' + currentUser + '/stats/neon_tree').once('value');
        if(snap.exists()) {
            state = snap.val();
            document.getElementById('sync-status').innerText = "Wczytano z chmury ☁️";
        }
    } catch(e) {
        document.getElementById('sync-status').innerText = "Błąd wczytywania ❌";
    }
}

function resetData() {
    if(confirm("Czy na pewno chcesz zresetować postęp?")) {
        state = {
            points: 0, pps: 0, pX: 2500, pY: 2500, speed: 6,
            unlockedNodes: ["up1"], purchasedLevels: { "up1": 0 }, lockedOut: [],
            teleports: []
        };
        saveToCloud();
        location.reload();
    }
}

// --- LOGIKA GRY ---
function toggleTP() {
    const menu = document.getElementById('tp-menu');
    menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
}

function init() {
    const map = document.getElementById('world-map');
    const svg = document.getElementById('path-layer');
    
    // Generowanie mapy
    for (let id in nodes) {
        const n = nodes[id];
        const div = document.createElement('div');
        div.className = 'node' + (n.type === "Teleportacja" ? " teleport-node" : "");
        div.id = `node-${id}`;
        div.style.left = n.x - 80 + 'px';
        div.style.top = n.y - 80 + 'px';
        map.appendChild(div);
        if (n.next) {
            n.next.forEach(targetId => {
                const target = nodes[targetId];
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", n.x); line.setAttribute("y1", n.y);
                line.setAttribute("x2", target.x); line.setAttribute("y2", target.y);
                line.id = `path-${id}-${targetId}`;
                svg.appendChild(line);
            });
        }
    }
    updateTPMenu();
    gameLoop();
}

function updateTPMenu() {
    const menu = document.getElementById('tp-menu');
    const toggle = document.getElementById('tp-toggle');
    menu.innerHTML = "";
    if(state.teleports && state.teleports.length > 0) {
        toggle.style.display = 'block';
        state.teleports.forEach(id => {
            const btn = document.createElement('button');
            btn.className = 'tp-btn';
            btn.innerText = `Skok: ${nodes[id].name}`;
            btn.onclick = () => { state.pX = nodes[id].x + 100; state.pY = nodes[id].y; toggleTP(); };
            menu.appendChild(btn);
        });
    }
}

function gameLoop() {
    let mx = 0, my = 0;
    const s = state.speed;
    if (keys['w'] || keys['arrowup']) my -= s;
    if (keys['s'] || keys['arrowdown']) my += s;
    if (keys['a'] || keys['arrowleft']) mx -= s;
    if (keys['d'] || keys['arrowright']) mx += s;
    
    state.pX += mx; state.pY += my;
    const v = document.getElementById('game-viewport');
    const m = document.getElementById('world-map');
    m.style.left = (v.clientWidth/2 - state.pX) + 'px';
    m.style.top = (v.clientHeight/2 - state.pY) + 'px';
    document.getElementById('player').style.left = (state.pX - 15) + 'px';
    document.getElementById('player').style.top = (state.pY - 15) + 'px';

    for (let id in nodes) {
        if (!state.unlockedNodes.includes(id) || state.lockedOut.includes(id)) continue;
        const n = nodes[id];
        if (Math.hypot(state.pX - n.x, state.pY - n.y) < 80) {
            if (state.points >= n.cost) buyNode(id);
        }
    }
    state.points += state.pps / 60;
    updateUI();
    requestAnimationFrame(gameLoop);
}

function buyNode(id) {
    const n = nodes[id];
    const lvls = state.purchasedLevels[id] || 0;
    if (lvls >= n.max) return;

    if (n.partOfChoice) {
        n.partOfChoice.forEach(altId => { if (!state.lockedOut.includes(altId)) state.lockedOut.push(altId); });
    }

    state.points -= n.cost;
    state.purchasedLevels[id] = lvls + 1;
    if (n.pps) state.pps += n.pps;
    if (n.speed) state.speed += n.speed;
    if (n.type === "Teleportacja" && !state.teleports.includes(id)) {
        state.teleports.push(id);
        updateTPMenu();
    }
    if (state.purchasedLevels[id] === 1 && n.next) {
        n.next.forEach(nxt => { if (!state.unlockedNodes.includes(nxt)) state.unlockedNodes.push(nxt); });
    }
    if(n.max > 1 && lvls < n.max) n.cost = Math.floor(n.cost * 1.5);
    
    saveToCloud(); // Zapisuj przy każdym zakupie
}

function updateUI() {
    document.getElementById('points').innerText = Math.floor(state.points).toLocaleString();
    document.getElementById('pps').innerText = state.pps.toFixed(1);

    for (let id in nodes) {
        const n = nodes[id];
        const el = document.getElementById(`node-${id}`);
        const isLocked = state.lockedOut.includes(id);

        if (state.unlockedNodes.includes(id) && !isLocked) {
            el.classList.add('visible');
            const lvls = state.purchasedLevels[id] || 0;
            el.innerHTML = `
                <div class="up-number">Upgrade #${n.num}</div>
                <div class="type-tag">${n.type}</div>
                <b>${n.name}</b>
                <i>${n.desc}</i>
                ${n.max > 1 ? `<small>Level ${lvls}/${n.max}</small>` : ""}
                <span class="cost-txt" style="color:${state.points >= n.cost ? '#4ade80' : '#f87171'}">
                    ${lvls >= n.max ? 'ACTIVE' : n.cost + ' Δ'}
                </span>
            `;
            if (state.points >= n.cost && lvls < n.max) el.classList.add('can-afford'); else el.classList.remove('can-afford');
            if (lvls >= n.max) el.classList.add('maxed');
            
            if (lvls > 0 && n.next) {
                n.next.forEach(nxt => { 
                    const l = document.getElementById(`path-${id}-${nxt}`);
                    if(l) {
                        if(state.lockedOut.includes(nxt)) l.classList.add('hidden');
                        else l.classList.add('active');
                    }
                });
            }
        } else {
            el.classList.remove('visible');
        }
    }
}

// Start gry
window.onload = async () => {
    await loadFromCloud();
    init();
    setInterval(saveToCloud, 10000); // Auto-zapis co 10 sekund
};
</script>
</body>
</html>
