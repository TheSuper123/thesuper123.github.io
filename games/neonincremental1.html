<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Neon Tree Exploration – SpinnerRealYT</title>
<link rel="icon" href="../Logo.png">
<style>
:root{ --bg:#020617; --card:#0f172a; --accent:#38bdf8; --text:#e5e7eb; --gold:#facc15; --path:#1e293b; --danger:#f87171;}
*{box-sizing:border-box}
body{ margin:0; font-family:Inter,sans-serif; background:var(--bg); color:var(--text); overflow:hidden; touch-action:none; }

/* VIEWPORT I MAPA */
#game-viewport {
    position: relative; width: 100vw; height: 100vh;
    overflow: hidden; background: #000;
}
#world-map {
    position: absolute; width: 5000px; height: 5000px;
    background-image: radial-gradient(circle, #1e293b 1px, transparent 1px);
    background-size: 50px 50px;
}

#player {
    position: absolute; width: 24px; height: 24px; background: var(--accent);
    box-shadow: 0 0 20px var(--accent); border-radius: 6px; z-index: 100;
    transition: transform 0.1s linear;
}

/* NODES */
.node {
    position: absolute; width: 100px; height: 100px; background: var(--card);
    border: 3px solid var(--path); border-radius: 15px; display: none;
    flex-direction: column; align-items: center; justify-content: center;
    font-size: 11px; text-align: center; padding: 10px; z-index: 50; transition: 0.3s;
}
.node.visible { display: flex; animation: fadeIn 0.5s forwards; }
.node.can-afford { border-color: #4ade80; box-shadow: 0 0 15px rgba(74, 222, 128, 0.2); }
.node.locked { filter: grayscale(1) opacity(0.3); pointer-events: none; }
.node.maxed { border-color: var(--gold); }

/* ŚCIEŻKI SVG */
#path-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
line { stroke: var(--path); stroke-width: 4; transition: 0.5s; }
line.active { stroke: var(--accent); stroke-dasharray: 10; animation: dash 1s linear infinite; }

@keyframes fadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
@keyframes dash { from { stroke-dashoffset: 20; } to { stroke-dashoffset: 0; } }

#ui { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); text-align: center; z-index: 200; pointer-events: none;}
.currency { font-size: 32px; font-weight: 800; color: var(--accent); text-shadow: 0 0 10px rgba(56, 189, 248, 0.5); }
</style>
</head>
<body>

<div id="ui">
    <div class="currency"><span id="points">0</span> Δ</div>
    <div style="opacity:0.7">Zysk: <span id="pps">0</span>/s</div>
</div>

<div id="game-viewport">
    <div id="world-map">
        <svg id="path-layer"></svg>
        <div id="player"></div>
        </div>
</div>

<script>
const currentUser = localStorage.getItem("sp_logged") || "guest";
const SAVE_KEY = `sp_save_neon_tree_${currentUser}`;

let state = {
    points: 0,
    pps: 1,
    pX: 2500, pY: 2500, // Start na środku mapy
    speed: 5,
    unlockedNodes: ["start"],
    purchasedLevels: { "start": 0 },
    lockedOut: [] // Tu trafią ulepszenia, których nie wybrano w "Choose"
};

// Definicja 10 buttonów (Drzewko)
const nodes = {
    "start": { x: 2500, y: 2500, name: "Rdzeń Energii", cost: 10, max: 10, pps: 1, next: ["gen_a", "gen_b"] },
    "gen_a": { x: 2300, y: 2300, name: "Ścieżka Mocy", cost: 100, max: 5, pps: 5, next: ["choose_1"] },
    "gen_b": { x: 2700, y: 2300, name: "Ścieżka Prędkości", cost: 100, max: 5, speed: 1, next: ["choose_1"] },
    "choose_1": { x: 2500, y: 2100, name: "WYBÓR: Specjalizacja", type: "choose", options: ["crit", "steady"], cost: 500, next: [] },
    "crit": { x: 2300, y: 1900, name: "Niestabilny Kryształ", cost: 1000, max: 1, pps: 50, next: ["end_1"] },
    "steady": { x: 2700, y: 1900, name: "Stabilny Reaktor", cost: 1000, max: 10, pps: 20, next: ["end_2"] },
    "end_1": { x: 2100, y: 1700, name: "Moc Pustki", cost: 5000, max: 5, pps: 200, next: [] },
    "end_2": { x: 2900, y: 1700, name: "Harmonia", cost: 5000, max: 5, pps: 150, next: [] },
    "speed_boost": { x: 2500, y: 2700, name: "Silnik Turbo", cost: 300, max: 3, speed: 2, next: ["final"] },
    "final": { x: 2500, y: 2900, name: "Brama Wyjścia", cost: 20000, max: 1, pps: 1000, next: [] }
};

const keys = {};
window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => keys[e.key.toLowerCase()] = false;

function init() {
    const saved = localStorage.getItem(SAVE_KEY);
    if(saved) state = JSON.parse(saved);

    const map = document.getElementById('world-map');
    const svg = document.getElementById('path-layer');

    for (let id in nodes) {
        const n = nodes[id];
        // Twórz HTML
        const div = document.createElement('div');
        div.className = 'node';
        div.id = `node-${id}`;
        div.style.left = n.x - 50 + 'px';
        div.style.top = n.y - 50 + 'px';
        map.appendChild(div);

        // Twórz linie ścieżek
        if (n.next) {
            n.next.forEach(targetId => {
                const target = nodes[targetId];
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", n.x); line.setAttribute("y1", n.y);
                line.setAttribute("x2", target.x); line.setAttribute("y2", target.y);
                line.id = `path-${id}-${targetId}`;
                svg.appendChild(line);
            });
        }
    }
    gameLoop();
}

function gameLoop() {
    // Ruch i Kamera
    let moveX = 0, moveY = 0;
    if (keys['w'] || keys['arrowup']) moveY -= state.speed;
    if (keys['s'] || keys['arrowdown']) moveY += state.speed;
    if (keys['a'] || keys['arrowleft']) moveX -= state.speed;
    if (keys['d'] || keys['arrowright']) moveX += state.speed;

    state.pX += moveX; state.pY += moveY;

    // Centrowanie kamery
    const v = document.getElementById('game-viewport');
    const m = document.getElementById('world-map');
    m.style.left = (v.clientWidth/2 - state.pX) + 'px';
    m.style.top = (v.clientHeight/2 - state.pY) + 'px';

    const p = document.getElementById('player');
    p.style.left = (state.pX - 12) + 'px';
    p.style.top = (state.pY - 12) + 'px';

    // Interakcja
    for (let id in nodes) {
        if (!state.unlockedNodes.includes(id) || state.lockedOut.includes(id)) continue;
        
        const n = nodes[id];
        const dist = Math.hypot(state.pX - n.x, state.pY - n.y);
        
        if (dist < 60 && state.points >= n.cost) {
            buyNode(id);
        }
    }

    state.points += state.pps / 60;
    updateUI();
    requestAnimationFrame(gameLoop);
}

function buyNode(id) {
    const n = nodes[id];
    const lvls = state.purchasedLevels[id] || 0;

    if (lvls >= n.max && n.type !== 'choose') return;

    state.points -= n.cost;
    
    if (n.type === 'choose') {
        // Logika wyboru
        const choice = prompt(`Wybierz ulepszenie: ${n.options[0]} czy ${n.options[1]}?`).toLowerCase();
        const selected = n.options.includes(choice) ? choice : n.options[0];
        const rejected = n.options.filter(o => o !== selected)[0];
        
        state.unlockedNodes.push(selected);
        state.lockedOut.push(rejected);
        state.purchasedLevels[id] = 1;
    } else {
        state.purchasedLevels[id] = lvls + 1;
        if (n.pps) state.pps += n.pps;
        if (n.speed) state.speed += n.speed;
        
        // Odblokuj następne i linie
        if (state.purchasedLevels[id] === 1 && n.next) {
            n.next.forEach(nxt => {
                if (!state.unlockedNodes.includes(nxt)) state.unlockedNodes.push(nxt);
            });
        }
        n.cost = Math.floor(n.cost * 1.5);
    }
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
}

function updateUI() {
    document.getElementById('points').innerText = Math.floor(state.points).toLocaleString();
    document.getElementById('pps').innerText = state.pps.toFixed(1);

    for (let id in nodes) {
        const n = nodes[id];
        const el = document.getElementById(`node-${id}`);
        if (state.unlockedNodes.includes(id) && !state.lockedOut.includes(id)) {
            el.classList.add('visible');
            const lvls = state.purchasedLevels[id] || 0;
            
            if (n.type === 'choose') {
                el.innerHTML = `<b>${n.name}</b><br>KOSZT: ${n.cost}`;
            } else {
                el.innerHTML = `<b>${n.name}</b><br>Lvl: ${lvls}/${n.max}<br>Koszt: ${n.cost}`;
            }
            
            if (state.points >= n.cost && lvls < n.max) el.classList.add('can-afford');
            else el.classList.remove('can-afford');
            
            if (lvls >= n.max) el.classList.add('maxed');

            // Aktywuj linie
            if (lvls > 0 && n.next) {
                n.next.forEach(nxt => {
                    const line = document.getElementById(`path-${id}-${nxt}`);
                    if (line) line.classList.add('active');
                });
            }
        }
    }
}

init();
</script>
</body>
</html>
